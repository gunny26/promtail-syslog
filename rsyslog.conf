global(processInternalMessages="on")

# 1. Korrigiere das Modul zu imtcp (Standard TCP Syslog) und deaktiviere das Framing
# WICHTIG: Verwenden Sie 'imtcp' und setzen Sie 'InputTCPServerRun'
# Dies ist die moderne rsyslog-Syntax:
module(load="imtcp")
module(load="impstats") 
module(load="imudp" TimeRequery="500")
module(load="mmjsonparse")
module(load="mmutf8fix")

# INPUT KONFIGURATION: Verwende imtcp mit expliziter Trennung
# Hier definieren wir, dass der TCP-Input auf Newlines als Trennung wartet (Traditional)
input(type="imtcp" port="514" Ruleset="mikrotik_split_rs" 
      # Deaktiviere Octet-Counting und verwende traditionelles Framing (Newline)
      InputTCPServerStreamDriverMode="0" 
      InputTCPServerStreamDriverAuthMode="anon")

input(type="imudp" port="514") # Beibehalten für den Fall der UDP-Nutzung

#################### RULES / FORWARDING ####################

# Das standardmäßige "default ruleset" wird hier verwendet, aber wir erstellen ein separates Ruleset

# --- NEU: RULES FÜR MIKROTIK ---
# Das "traditional" Template fügt am Ende eines Parsings ein Newline ein, 
# was das Aggregationsproblem beheben sollte.

# WICHTIG: Verwenden Sie ein Ruleset, um die Log-Formatierung zu steuern
ruleset(name="mikrotik_split_rs") {
    # 1. TEMPLATE setzen: Das traditionelle Format garantiert einen Newline-Terminator
    action(type="omfwd" protocol="tcp" target="localhost" port="1514" 
           Template="RSYSLOG_TraditionalFormat" 
           # Entfernen Sie TCP_Framing="octet-counted" hier oder setzen Sie es auf "on"
           KeepAlive="on")
}

# we emit our own messages to docker console:
*.* action(type="omfwd" protocol="tcp" target="localhost" port="1514" 
           Template="RSYSLOG_SyslogProtocol23Format" 
           TCP_Framing="octet-counted" 
           KeepAlive="on")
